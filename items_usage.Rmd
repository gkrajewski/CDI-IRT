---
title: "Items usage in CAT"
author: "Piotr Król"
date: "24 08 2021"
output: html_document
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
```

```{r libraries, warning=F, message=F}
library(mirtCAT)
library(parallel)
library(ggpubr)
library(plyr)
```

```{r data preparation}
responses_demo <- read.csv("Data/responses_demo.csv", encoding = "UTF-8")
responses <- as.matrix(responses_demo[,5:ncol(responses_demo)])
cdi <- read.csv("Data/cdi.csv", encoding = "UTF-8")
load("Data/items_to_remove")
load("Data/params")
load("Data/fscores")
load("Data/mod_r")
load("Data/start_thetas")
responses <- responses[, -items_to_remove]
cdi <- cdi[!cdi$number.ws %in% items_to_remove, ]
source(paste0(getwd(),"/get_sim_results.R"))
```

```{r ready report data, include=F}
load("Data/items_usage.RData")
```

Investigate items parameters:

```{r }
mod_r
```

```{r eval=F}
params_IRT <- as.data.frame(coef(mod_r, simplify = T, IRTpars = T)$items)[1:2]
```

```{r fig.width=12, fig.height=8}
params_cdi <- cbind(params_IRT, cdi)
ggplot(params_cdi, aes(b, a, colour=category, label=position)) +
  geom_text(check_overlap = T) +
  geom_point(alpha = 0.3) +
  xlab("Difficulty") +
  ylab("Discrimination") +
  labs(colour = "Category") +
  theme(
  panel.background = element_rect(fill = NA),
  panel.grid.major = element_line(colour = "grey"),
  legend.position = "top"
)
```

Make simulation with recommended settings:

```{r eval=F}
sim_results <- mirtCAT(
    mo = generate.mirt_object(params, '2PL'),
    method = "MAP",
    criteria = "MI",
    start_item = "MI",
    local_pattern = responses,
    cl = makeCluster(detectCores()),
    design = list(min_items = 10, min_SEM = 0.1, max_items = 50)
  )
```

Plot with colour by frequency:

```{r fig.width=12, fig.height=8}
raw_responses <- laply(sim_results, function(x) x$raw_responses)
freq <- round(apply(raw_responses, 2, function(x) length(which(!is.na(x))))/nrow(responses), 3)*100
params_cdi$freq <- freq

ggplot(params_cdi[!params_cdi$number.ws == 457, ], aes(b, a, label=position, colour=freq)) + #Remove 'kupić' since it has 100% frequency
  geom_text(check_overlap = T) +
  geom_point(alpha = 0.3) +
  xlab("Difficulty") +
  ylab("Discrimination") +
  labs(colour = "Frequency (%)") +
  scale_color_gradient(low="red", high="green") + 
  theme(
  panel.background = element_rect(fill = NA),
  panel.grid.major = element_line(colour = "grey"),
  legend.position = "top"
)
```
Most popular categories:

```{r}
items_used <- apply(raw_responses, 1, function(x) which(!is.na(x)))
cat_categories <- cdi[unlist(items_used, use.names = F), "category"]
cat_categories  <- as.data.frame(round(sort(table(cat_categories) / length(cat_categories), decreasing=T), 3) * 100)
colnames(cat_categories) <- c("category", "freq")
```

```{r}
cdi_categories <- as.data.frame(round(sort(table(cdi$category) / nrow(cdi), decreasing = T), 3) * 100)
colnames(cdi_categories) <- c("category", "freq")
```

```{r}
categories_used <- merge(cat_categories, cdi_categories, by="category", suffixes = c("_CAT", "_full"))
categories_used$diff <- categories_used$freq_CAT - categories_used$freq_full
categories_used$mean_dscr <- round(aggregate(a ~ category, data = params_cdi, mean)$a, 2)
categories_used$mean_dfclt <- round(aggregate(b ~ category, data = params_cdi, mean)$b, 2)
categories_used
```
```{r eval=F}
cl <- makeCluster(detectCores())
sim_results_st <- mirtCAT(mo = mo, method = "MAP", criteria = "MI", start_item = "MI", local_pattern = responses, cl = cl, design = list(min_items = 10, min_SEM = 0.1, max_items = 50, thetas.start = start_thetas - 2))
save.image("Data/items_usage.RData")
```